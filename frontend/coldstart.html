<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cold Start - Postgres and Chill</title>
<link rel="icon" href="logo.png" />

<style>
:root{
  --bg:#0e0e0e;
  --panel:#141414;
  --card:#1a1a1a;
  --cardHover:#202020;
  --text:#f5f5f5;
  --muted:#b9b9b9;
  --brand:#DFA601;
  --brand2:#f0c52b;
  --shadow:0 4px 16px rgba(0,0,0,0.35);
}

html, body {
  height:100%;
  margin:0;
  display:flex;
  flex-direction:column;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER ================= */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px 25px;
  background:var(--panel);
  box-shadow:var(--shadow);
}
.header-left{
  display:flex;
  align-items:center;
  gap:10px;
}
header img.logo{height:40px;}
header h1{
  color:var(--brand);
  font-size:1.8rem;
  margin:0;
}

.header-center{
  color:var(--brand);
  font-size:1rem;
  white-space:nowrap;
}

.header-right{
  display:flex;
  align-items:center;
  gap:14px;
}
.nav-link{
  color:#bfbfbf;
  text-decoration:none;
  font-weight:500;
  font-size:.95rem;
  transition:.2s;
}
.nav-link:hover{
  color:var(--brand);
}
.auth-btn{
  background:transparent;
  border:1px solid var(--brand);
  color:var(--brand);
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.auth-btn:hover{
  background:var(--brand);
  color:#141414;
}
.header-right img.pnw{height:35px;}

/* ================= MAIN ================= */
main{
  flex:1;
  padding:20px;
  display:flex;
  flex-direction:column;
  /* ‚ùå removed fixed height so footer doesn't sit on top of cards */
  /* height:calc(100vh - 120px); */
}

.cs-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.cs-top h2{
  margin:0;
  font-size:1.5rem;
  color:var(--brand);
}

.refresh-btn{
  background:transparent;
  border:1px solid var(--brand);
  padding:8px 16px;
  border-radius:8px;
  cursor:pointer;
  color:var(--brand);
  font-weight:600;
  transition:.25s;
}
.refresh-btn:hover{
  background:var(--brand);
  color:#141414;
}

/* ===== EXACTLY TWO ROW GRID ===== */
#movieGrid{
  /* width is content-based now so we can center it */
  width:auto;
  flex:none;
  height:650px; /* two rows worth of height */
  display:grid;

  /* 2 rows */
  grid-template-rows:repeat(2, 1fr);

  /* columns auto-generated, fixed width */
  grid-auto-flow:column;
  grid-auto-columns:180px;

  gap:18px;
  margin-top:20px;

  /* center whole grid block horizontally */
  margin-left:auto;
  margin-right:auto;
  justify-content:center;

  /* no need to overflow; we only render what fits */
  overflow:visible;
}

/* ===== CARD STYLE ===== */
.movie-card{
  background:var(--card);
  border-radius:12px;
  padding:10px;
  cursor:pointer;
  box-shadow:0 2px 5px rgba(0,0,0,.5);
  display:flex;
  flex-direction:column;
  align-items:center;
  transition:transform .2s, background-color .2s;
}
.movie-card:hover{
  transform:scale(1.05);
  background:var(--cardHover);
}

.movie-card img{
  width:100%;
  height:220px;
  object-fit:cover;
  border-radius:10px;
}

.movie-card h3{
  margin:6px 0 2px;
  font-size:0.95rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  width:100%;
  text-align:center;
}
.movie-card p{
  margin:0;
  font-size:0.8rem;
  color:var(--muted);
}

/* Inline stars */
.inline-stars{
  margin-top:6px;
  display:flex;
  justify-content:center;
  gap:3px;
}
.inline-star{
  cursor:pointer;
  font-size:1.15rem;
  color:#444;
  transition:transform .1s, color .1s;
}
.inline-star.active{
  color:var(--brand);
}
.inline-star:hover{
  transform:scale(1.2);
}

/* CENTERED ACTION BUTTONS */
.cs-actions{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:25px;
}

.cs-btn{
  padding:10px 20px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  border:1px solid var(--brand);
  color:var(--brand);
  background:transparent;
}
.cs-btn:hover{
  background:var(--brand);
  color:#141414;
}

.finish-btn{
  padding:10px 20px;
  background:var(--brand);
  border-radius:8px;
  border:1px solid var(--brand);
  cursor:pointer;
  font-weight:600;
  color:#141414;
}
.finish-btn:hover{
  background:var(--brand2);
}

/* POPUP */
#popup{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.popup-content{
  background:#1e1e1e;
  padding:25px;
  border-radius:12px;
  width:360px;
  text-align:left;
  box-shadow:0 2px 8px rgba(0,0,0,.6);
  animation:fadeIn .2s;
}
.popup-content h3{
  margin-top:0;
  color:var(--brand);
}
.popup-row{color:#ddd;margin:6px 0;font-size:0.9rem;}

.stars{
  display:flex;
  justify-content:center;
  gap:4px;
  margin:12px 0;
}
.stars span{
  font-size:1.8rem;
  cursor:pointer;
  color:#555;
}
.stars span.active{
  color:var(--brand);
}

.popup-actions{
  display:flex;
  gap:10px;
  margin-top:15px;
}
.close-btn{
  flex:1;
  padding:9px;
  background:var(--brand);
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
  color:#141414;
}
.close-btn:hover{
  background:var(--brand2);
}
.clear-btn{
  flex:1;
  padding:9px;
  background:transparent;
  border:1px solid var(--brand);
  color:var(--brand);
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.clear-btn:hover{
  background:#2a2a2a;
}

@keyframes fadeIn{
  from{opacity:0;transform:scale(.95);}
  to{opacity:1;transform:scale(1);}
}

/* FOOTER */
footer{
  background:#111;
  padding:12px;
  text-align:center;
  border-top:1px solid #222;
  font-size:0.85rem;
  color:#bbb;
}
footer strong{color:var(--brand);}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="logo.png" class="logo">
    <h1>Postgres and Chill</h1>
  </div>

  <div class="header-center" id="welcomeCenter">Welcome</div>

  <div class="header-right">
    <a href="about.html" class="nav-link">About</a>
    
    <button class="auth-btn" onclick="location.href='index.html'">Home</button>
  </div>
</header>

<main>
  <div class="cs-top">
    <h2>Rate a Few Movies</h2>
  </div>

  <p style="color:#ccc;margin-top:5px;">
    Help us get to know your taste
  </p>

  <div id="movieGrid">Loading...</div>

  <!-- ‚≠ê Centered buttons -->
  <div class="cs-actions">
    <button class="cs-btn" onclick="skipColdStart()">Skip</button>
    <button class="cs-btn" onclick="refreshMovies()">Refresh Movies</button>
    <button class="finish-btn" onclick="finishColdStart()">Finish</button>
  </div>
</main>

<div id="popup"></div>

<footer>
  <p><strong>Postgres & Chill</strong>: Smarter Movie Recommendations</p>
  <p>CS 51550-001 Database Systems @ PNW ‚Äî Fall 2025</p>
</footer>

<script>
const apiBase = "http://localhost:8080/api";
let userId = localStorage.getItem("pc_userId");
let userRatings = {};
let coldMovies = [];

/* Set welcome text */
const name = localStorage.getItem("pc_userName");
if (name) document.getElementById("welcomeCenter").textContent = `Welcome, ${name}`;

/* Convert DB row */
function toMovie(r){
  return {
    id: r[0], title: r[1], year: r[2],
    rating: Number(r[3]||0),
    ratingCount: Number(r[4]||0),
    genres: r[5] ? r[5].split(",") : []
  };
}

/* shuffle all movies */
function chooseMovies(all){
  return [...all].sort(() => Math.random() - 0.5);
}

/* üî¢ how many cards per row fit on screen */
function getCardsPerRow(){
  const cardWidth = 180;   // must match grid-auto-columns
  const gap = 18;          // must match CSS gap
  const padding = 40;      // approx main padding left+right

  const usable = window.innerWidth - padding;
  const perRow = Math.max(1, Math.floor((usable + gap) / (cardWidth + gap)));
  return perRow;
}

/* render using current coldMovies + viewport */
function renderMovies(){
  const grid = document.getElementById("movieGrid");
  grid.innerHTML = "";

  const perRow = getCardsPerRow();
  const visibleCount = perRow * 2; // 2 rows

  const moviesToShow = coldMovies.slice(0, visibleCount);

  moviesToShow.forEach(m=>{
    const rating = userRatings[m.id] || 0;

    const card = document.createElement("div");
    card.className = "movie-card";

    card.innerHTML = `
      <img src="movie.png">
      <h3>${m.title}</h3>
      <p>${m.year || ""}</p>
      <div class="inline-stars" data-id="${m.id}">
        ${[1,2,3,4,5].map(i =>
          `<span class="inline-star ${i<=rating?'active':''}" data-star="${i}">‚òÖ</span>`
        ).join("")}
      </div>
    `;

    card.addEventListener("click",(e)=>{
      if (e.target.classList.contains("inline-star")) return;
      openPopup(m);
    });

    setupInlineStars(card, m);
    grid.appendChild(card);
  });
}

/* Refresh button = refetch + reshuffle + rerender */
async function refreshMovies(){
  await loadMovies();
}

/* fetch movies once, shuffle, then render subset that fits */
async function loadMovies(){
  const res = await fetch(`${apiBase}/movies`);
  const rows = await res.json();
  coldMovies = chooseMovies(rows.map(toMovie));
  renderMovies();
}

function setupInlineStars(card, movie){
  const stars = card.querySelectorAll(".inline-star");
  let current = userRatings[movie.id] || 0;

  function draw(r){
    stars.forEach(s=>{
      s.classList.toggle("active", Number(s.dataset.star) <= r);
    });
  }
  draw(current);

  stars.forEach(s=>{
    s.addEventListener("click",(e)=>{
      e.stopPropagation();
      const v = Number(s.dataset.star);
      userRatings[movie.id] = v;
      current = v;
      draw(v);
    });

    s.addEventListener("mouseenter",()=>{
      draw(Number(s.dataset.star));
    });
  });

  card.querySelector(".inline-stars").addEventListener("mouseleave",()=>draw(current));
}

/* POPUP */
function openPopup(movie){
  const popup = document.getElementById("popup");
  popup.style.display = "flex";

  const r = userRatings[movie.id] || 0;

  popup.innerHTML = `
    <div class="popup-content" onclick="event.stopPropagation()">
      <h3>${movie.title}</h3>
      <div class="popup-row"><strong>Year:</strong> ${movie.year}</div>
      <div class="popup-row"><strong>Genres:</strong> ${movie.genres.join(", ")}</div>

      <div class="stars">
        ${[1,2,3,4,5].map(i =>
          `<span data-star="${i}" class="${i<=r?'active':''}">‚òÖ</span>`
        ).join("")}
      </div>

      <div class="popup-actions">
        <button class="close-btn" onclick="closePopup()">Close</button>
        <button class="clear-btn" onclick="clearRating(${movie.id})">Clear Rating</button>
      </div>
    </div>
  `;

  popup.querySelectorAll(".stars span").forEach(s=>{
    s.addEventListener("click",()=>{
      const v = Number(s.dataset.star);
      userRatings[movie.id] = v;
      updateInline(movie.id);
      openPopup(movie);
    });
  });

  popup.onclick = e=>{ if(e.target.id==="popup") closePopup(); };
}

function closePopup(){
  document.getElementById("popup").style.display="none";
}

function clearRating(id){
  delete userRatings[id];
  updateInline(id);
  closePopup();
}

function updateInline(id){
  document
    .querySelectorAll(`.inline-stars[data-id="${id}"] .inline-star`)
    .forEach(s=>{
      s.classList.toggle("active", Number(s.dataset.star) <= (userRatings[id]||0));
    });
}

/* Skip + Finish */
function skipColdStart(){
  location.href = "dashboard.html";
}

async function finishColdStart(){
  if (!userId) return alert("User not found.");

  await fetch(`${apiBase}/users/${userId}/ratings`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(userRatings)
  });

  location.href = "dashboard.html";
}

/* initial load */
loadMovies();

/* on resize: recompute how many fit and rerender, no refetch */
window.addEventListener("resize", renderMovies);
</script>

<script src="js/health-check.js"></script>

</body>
</html>
